---
title: "WINDOWS HARDENING"
categories:
  - Edge Case
tags:
  - content
  - css
  - edge case
  - lists
  - markup
---


## **Logs, SIEM, and Threat Detection**

### ðŸ” 1. **Logs Everywhere**

In a network, multiple devices (endpoints, servers, routers, firewalls, websites, etc.) constantly **generate logs** that record all activities. These logs help analysts **detect malicious activities**, troubleshoot issues, and ensure system integrity.

#### **Two main types of log sources:**

| Type                | Description                                                                                  | Examples of Logs                                                                                     |
| ------------------- | -------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| **Host-Centric**    | Logs generated by endpoints (Windows, Linux, servers). They record internal host activities. | File access, authentication attempts, process execution, registry modifications, PowerShell commands |
| **Network-Centric** | Logs generated by devices monitoring communications across the network.                      | Firewall logs, SSH connections, FTP transfers, web traffic, VPN access, SMB sharing                  |

### âš ï¸ 2. **Challenges in Log Analysis 

Analyzing logs is complex due to several **operational challenges**:

1. **Numerous Log Sources:** Many devices produce thousands of events per second.
    
2. **No Centralization:** Logs remain on each device, requiring manual access (SSH, RDP).
    
3. **Limited Context:** Individual logs seem harmless but, when correlated, may reveal attacks (e.g., lateral movement).
    
4. **Limited Analysis Capability:** Humans canâ€™t manually review millions of logs.
    
5. **Format Issues:** Logs come in multiple formats (Windows Event, syslog, Apache, etc.).
    

 **Solution:** Centralized systems that aggregate, normalize, and correlate logs â€” i.e., **SIEM**.

### ðŸ›¡ï¸ 3. **SIEM (Security Information and Event Management)**

A **SIEM** platform centralizes logs from multiple devices, **standardizes** their formats, **correlates** data, and **detects threats** through predefined or custom rules.

#### ðŸ§© **Core Features of SIEM:**

| Feature                        | Function                                                                                                |
| ------------------------------ | ------------------------------------------------------------------------------------------------------- |
| **Centralized Log Collection** | Collects logs from all endpoints, servers, and network devices in one location (via agents or APIs).    |
| **Normalization of Logs**      | Converts logs of different formats into a consistent structure using **parsing** and **normalization**. |
| **Correlation of Logs**        | Finds relationships between different events to detect suspicious activity patterns.                    |
| **Real-time Alerting**         | Triggers alerts based on detection rules (e.g., brute-force, data exfiltration).                        |
| **Dashboards & Reporting**     | Provides visual insights: alerts, failed logins, event counts, system health, top domains, etc.         |

#### ðŸ§  Example of SIEM Correlation:

- User **Haris** logs in from an unknown IP via VPN â†’ accesses sensitive documents â†’ runs PowerShell â†’ outbound connection.  
    Individually benign, but **correlated**, it indicates **possible data exfiltration**.


### ðŸ–¥ï¸ 4. **Common Log Sources**

#### ðŸªŸ **Windows Machine**

- Logs viewed in **Event Viewer**.
    
- Each event type has a **unique Event ID** (e.g., 4625 = failed login, 4688 = process creation).
    
- Logs from endpoints are **forwarded to the SIEM**.

#### ðŸ§ **Linux Machine**

- Logs stored mainly under `/var/log/`.
    
    |Path|Description|
    |---|---|
    |`/var/log/httpd`|Web (HTTP) request and error logs|
    |`/var/log/cron`|Cron job events| records the automated tasks 
    |`/var/log/auth.log` / `/var/log/secure`|Authentication logs|
    |`/var/log/kern`|Kernel events|
    
    **Example:**
    
    ```
    Jun 13 07:46:22 ebr crond[3592]: unable to exec /usr/sbin/sendmail: cron output for user root job sys-daily to /dev/null
    ```
#### ðŸŒ **Web Server (Apache)**

- Logs stored in `/var/log/apache` or `/var/log/httpd`.  
    **Example:**
    
    ```
    192.168.21.200 - - [21/Mar/2022:10:17:10 -0300] "GET /cgi-bin/try/ HTTP/1.0" 200 3395 "-" "Mozilla/5.0 ..."
    ```

### ðŸ”„ 5. **Log Ingestion Methods in SIEM**

| Method                | Description                                                                                                    |
| --------------------- | -------------------------------------------------------------------------------------------------------------- |
| **Agent / Forwarder** | Lightweight tool installed on endpoints (e.g., **Splunk Forwarder**) that captures and sends logs to the SIEM. |
| **Syslog**            | Standard protocol for real-time log forwarding from devices (servers, firewalls, etc.).                        |
| **Manual Upload**     | Analysts can upload offline logs (CSV, JSON, etc.) for analysis.                                               |
| **Port-Forwarding**   | SIEM listens on a specific port where endpoints send data directly.                                            |

### âš™ï¸ 6. **Detection Rules â€” The Logic Behind Alerts**

SIEM uses **logical conditions** (rules) to detect abnormal activities and trigger alerts.

#### ðŸ§© **Examples of Detection Rules:**

| Rule                                | Trigger Condition                           | Description                    |
| ----------------------------------- | ------------------------------------------- | ------------------------------ |
| **Multiple Failed Logins**          | 5 failed logins within 10 sec               | Possible brute-force attack    |
| **Successful Login After Failures** | Success after multiple failures             | Possible credential compromise |
| **USB Detection**                   | USB inserted event                          | Policy violation               |
| **Large Outbound Traffic**          | > 25 MB transferred                         | Possible data exfiltration     |
| **Event Log Cleared**               | Event ID = 104 (Windows)                    | Attacker trying to hide tracks |
| **whoami Command Execution**        | Event ID = 4688 + `NewProcessName` = whoami | Privilege enumeration          |

These rules rely on **field-value pairs** (like `EventID`, `Username`, `ProcessName`) extracted from normalized logs.

### ðŸš¨ 7. **Alert Investigation Process**

Once SIEM triggers an alert, analysts investigate it to confirm if itâ€™s a **true positive (real attack)** or **false positive**.

#### ðŸ” **Investigation Workflow:**

1. Review **dashboards** and alerts summary.
    
2. Examine related **logs and events** linked to the alert.
    
3. Verify which **rule condition** was met.
    
4. Classify the alert:
    
    - **False Positive:** Tune or modify the detection rule.
        
    - **True Positive:** Begin incident response.
#### ðŸ§° **Incident Response Actions:**

- Contact the **asset owner** to verify the activity.
    
- If **suspicious activity confirmed**:
    
    - **Isolate** the infected host from the network.
        
    - **Block** the malicious IP or domain.
        
    - **Document** and escalate the incident for remediation.



# Tracking Accounts Login and Management
### Account Login Tracking

This section of the book focuses on using Windows Event Logs to monitor and investigate user authentication activities, which is crucial for profiling user behavior and identifying compromised accounts.

#### 1. Account Login Tracking

This is the overarching topic for tracking all login attempts (successful and failed) recorded in the Windows Security log.

**Key Concepts:**

- Everything in Windows (processes, services, authentication) is tied to an account.
    
- Tracking account logins is the first effective way to investigate an attacker's activities.
    
- All authentication logs are stored in theÂ **Security.evtx**Â log file.
    

#### 2. Windows Accounts

Understanding the different types of Windows accounts is essential to interpret login events correctly.

**Subsections and Key Concepts:**

- **Standard Accounts:**
    
    - These are regular user accounts created for employees (e.g., local user accounts, domain user accounts).
        
    - They have limited privileges and cannot perform system-level tasks like installing software or changing system settings.
        
    - Using standard accounts improves security by limiting the damage from a compromise.
        
- **Default Local System Accounts:**
    
    - These are built-in accounts used by the operating system and services. They are not meant for interactive user login.
        
    - **SYSTEM:**Â The most powerful account with complete control over the system. Used by high-privilege services.
        
    - **NETWORK SERVICE:**Â A limited-privilege account that can authenticate to remote servers using the computer's credentials.
        
    - **LOCAL SERVICE:**Â A limited-privilege account for local services that does not authenticate over the network.
        
    - **COMPUTERNAME$:**Â The computer account created when a machine joins a domain. Used for domain authentication.
        
    - **ANONYMOUS LOGON:**Â Used for network communications that do not require explicit credentials.
        

#### 3. Tracking Successful Logins

**Event ID: 4624 - "An account was successfully logged on"**

This event is critical for profiling user activity and investigating breaches.

**Important Fields in Event ID 4624:**

- **Logon Information > Logon Type:**Â A numeric code indicatingÂ _how_Â the user logged on. Crucial for understanding the context.
    
    - **2:**Â Interactive logon (at the keyboard).
        
    - **3:**Â Network logon (e.g., accessing a file share over SMB).
        
    - **10:**Â Remote interactive logon (RDP).
        
- **New Logon Section:**Â Details about the user who logged on.
    
    - **Account Name:**Â The username.
        
    - **Account Domain:**Â Helps identify if it's a local or domain account.
        
    - **Logon ID:**Â A unique identifier for the logon session.
        
- **Network Information Section:**Â Shows the source of the logon attempt.
    
    - **Source Network Address:**Â The IP address of the machine where the credentials were entered. Vital for investigating lateral movement.
        

**Use Cases:**Â Identify compromised account activities, detect RDP logins from unusual workstations or public IPs, find unauthorized network share access, and spot logins outside working hours.

#### 4. Tracking Successful Administrator Logins

**Event ID: 4672 - "Special privileges assigned to new logon"**

This event specifically tracks logins by accounts with administrative privileges, which are high-value targets for attackers.

**Key Concepts:**

- When an admin account logs in,Â **two events are always recorded together**:
    
    1. **Event ID 4624**Â (Successful logon)
        
    2. **Event ID 4672**Â (Special privileges assigned)
        
- The event lists the specific administrative privileges (e.g., SeDebugPrivilege, SeBackupPrivilege) assigned to the logon session.
    
- Investigating these events is crucial because attackers need administrative privileges to achieve goals like accessing sensitive data or deploying malware.

#### 5. Tracking Logon Sessions

This section explains how to use theÂ **Logon ID**Â field to track a user's activities during a specific session and determine the session's duration.

**Key Concepts:**

- TheÂ **Logon ID**Â is a unique value for each session and is present in most security events, allowing you to correlate all actions performed during that session (e.g., process execution, file access).
    
- To calculate theÂ **length of an interactive session**Â (e.g., Logon Types 2, 10), you must correlate the logon event with a logoff event.
    
- **Event ID 4634 - "An account was logged off"**Â indicates the end of a session.
    
- **Process:**Â Find aÂ **4624**Â event (logon) and a subsequentÂ **4634**Â event (logoff) that share the sameÂ **Logon ID**. Subtract the timestamps to find the session duration.
    
- For non-interactive logons (e.g.,Â **Logon Type 3**Â for network shares), the session starts and ends almost instantly upon accessing the resource, so calculating duration is not useful.

### Tracking Failed Logins & Account Management

#### 1. Tracking Failed Logins (The "Who's Knocking?" Log)

- **Event ID to Hunt:**Â **4625 - "An account failed to log on."**
    
- **Why It Matters:**Â This is your primary alert for password attacks. Attackers constantly try to guess passwords to break in.
    
- **The "Failure Info" Section is Key:**
    
    - It tells youÂ _why_Â the login failed.
        
    - **`0xC0000064`:**Â "User doesn't exist." (Attacker is guessing usernames)
        
    - **`0xC000006A`:**Â "Wrong password." (Attacker has the right user, wrong pass)
        
    - **`0xC0000234`:**Â "Account is locked out." (Too many wrong tries!)
        
- **Simple Attack Detection:**
    
    - **Brute-Force:**Â Many failed logins forÂ **one user**.
        
    - **Password Spraying:**Â A few failed logins forÂ **many different users**.
        
- **The "Lockout" Event:**Â After too many failures, Windows locks the account and logsÂ **Event ID 4740 - "A user account was locked out."**Â This is a big red flag.
    
---
#### 2. Login Validation Events (The "Bouncer's" Log)

- **The Big Idea:**Â While logon events (4624, 4625) are on the computer the user tried to access,Â **validation events are on the server that checked the password**Â (like a Domain Controller).
    
- **For NTLM Logins:**
    
    - **Event ID: 4776**Â - Tracks both successful and failed credential checks.
        
    - The "Error Code" here means the same thing as the "Sub Status" in Event 4625.
        
- **For Kerberos Logins:**
    
    - **Failure Event ID: 4771**Â - "Kerberos pre-authentication failed."
        
    - It has its own set of "Failure Codes" (e.g.,Â `0x18`Â means "Wrong password").

---
#### 3. Account and Group Management Tracking (The "Who Made a New Key?" Log)

Attackers create new accounts or add themselves to powerful groups to maintain access.
#### A. Tracking Account Creation, Deletion, and Changes

- **The Most Important Event:**Â **4720 - "A user account was created."**
    
- **What to Look For:**
    
    - **Subject:**Â Who created the account? (e.g.,Â `SOC\administrator`)
        
    - **New Account:**Â What is the name of the newly created account? (e.g.,Â `SOC\HackerAccount`)
        
- **Other Key Management Events:**
    
    - **4722:**Â User account wasÂ **enabled**.
        
    - **4725:**Â User account wasÂ **disabled**.
        
    - **4726:**Â User account wasÂ **deleted**.
        
    - **4738:**Â User account wasÂ **changed**Â (e.g., password reset).
        
#### B. Tracking Creation and Account Adding to Security Groups

- **The "Oh No!" Event:**Â **4728 - "A member was added to a security-enabled global group."**
    
- **Why It's Critical:**Â This tells you theÂ **privileges**Â of a new account. An account is harmless until it's added to a powerful group.
    
- **The Golden Trio of Information:**
    
    1. **Who did it?**Â (Subject - e.g.,Â `SOC\Administrator`)
        
    2. **Which user was added?**Â (Member - e.g.,Â `SOC\HackerAccount`)
        
    3. **To which powerful group?**Â (Group - e.g.,Â `Domain Admins`)
        
- **The Attacker's Playbook:**Â An attacker's goal is often:Â **Create Account (4720)**Â ->Â **Add to Admin Group (4728)**Â = Total Control.


